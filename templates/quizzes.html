<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz Zone - Celestium</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .quiz-container { max-width: 800px; margin: 80px auto; background: rgba(30, 30, 40, 0.9); padding: 40px; border-radius: 15px; border: 1px solid #444; min-height: 400px;}
        .question { font-size: 1.5rem; color: #fff; margin-bottom: 30px; }
        .option-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #222; color: white; border: 1px solid #555; border-radius: 8px; cursor: pointer; text-align: left; font-size: 1.1rem; transition: 0.2s; }
        .option-btn:hover { background: #333; border-color: #4facfe; }
        .correct { background: #2ecc71 !important; border-color: #27ae60 !important; }
        .wrong { background: #e74c3c !important; border-color: #c0392b !important; }
        .feedback { margin-top: 20px; padding: 15px; background: #2a2a3a; border-left: 4px solid #4facfe; display: none; color: #ddd; }
        
        #loading-ai { text-align: center; color: #4facfe; margin-top: 50px; }
        .ai-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Celestium</div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/universe">Universe Explorer</a>
            <a href="/lessons">LearnCore</a>
            <a href="/quizzes" style="color: #4facfe;">Quiz Zone</a>
            <a href="/missions">Mission Builder</a>
        </div>
    </nav>

    <div class="quiz-container">
        <h1 style="text-align: center; color: #4facfe;">AI-Generated Quiz</h1>
        <p id="quiz-topic" style="text-align: center; color: #888;">Analyzing your learning path...</p>
        <hr style="border-color: #444; margin-bottom: 30px;">

        <div id="loading-ai">
            <h2 class="ai-pulse">Generating Questions...</h2>
            <p>NLP Model is converting lesson data into a quiz.</p>
        </div>

        <div id="quiz-area" style="display: none;">
            <h2 id="q-text" class="question"></h2>
            <div id="options"></div>
            
            <div id="feedback" class="feedback">
                <strong id="feedback-title"></strong>
                <p id="feedback-msg"></p>
                <button onclick="nextQuestion()" style="margin-top:10px; padding:8px 20px; background:#4facfe; border:none; color:black; border-radius:5px; cursor:pointer; font-weight:bold;">Next Question</button>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let currentTopic = localStorage.getItem('currentLessonTitle'); 

        async function submitResult() {
            const topic = localStorage.getItem('currentLessonTitle');
            const totalQuestions = questions.length;

            try {
                const response = await fetch('/api/submit_quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic, score: score, total: totalQuestions })
                });

                if (response.ok) {
                    console.log("Quiz results saved.");
                }
            } catch (error) {
                console.error("Network error during submission:", error);
            }
        }
        
        async function fetchRecommendation() {
            const area = document.getElementById('recommendation-area');
            try {
                const response = await fetch('/api/get_recommendation');
                const recommendation = await response.json();
                
                area.innerHTML = `
                    <h3 style="color:#2ecc71; text-align:center; text-transform:uppercase;">AI Learning Path</h3>
                    <p style="font-size:1.1rem; text-align:center;">
                        <span style="color:#ffcc00; font-weight:bold;">Next Recommended Topic:</span> 
                        <span style="color:#4facfe;">${recommendation.next_topic}</span>
                    </p>
                    <p style="text-align:center; color:#ddd;">"${recommendation.reason}"</p>
                    <button onclick="window.location.href='/lessons'" class='option-btn' style='margin-top:20px;'>Continue Learning</button>
                `;
            } catch (error) {
                area.innerHTML = `<h3 style="color:red; text-align:center;">Recommendation Failed.</h3>`;
            }
        }

        function endQuiz() {
            submitResult();
            
            document.getElementById('quiz-area').innerHTML = `
                <h2 style='text-align:center; color:white;'>Quiz Complete! ðŸŽ‰</h2>
                <p style='text-align:center; font-size:1.5rem;'>Score: ${score} / ${questions.length}</p>
                <hr style='border-color:#444; margin:30px 0;'>
                <div id="recommendation-area">
                    <h3 style="color:#4facfe; text-align:center;">Analyzing Progress...</h3>
                    <p style="text-align:center;">Fetching personalized next step...</p>
                </div>
            `;
            fetchRecommendation();
        }

        async function initQuiz() {
            const lessonText = localStorage.getItem('currentLessonText');

            if (!lessonText) {
                document.getElementById('loading-ai').innerHTML = "<h2>No Lesson Selected.</h2><p>Go to LearnCore and select a topic first.</p><a href='/lessons' style='color:#4facfe'>Back to Lessons</a>";
                return;
            }

            document.getElementById('quiz-topic').innerText = `Topic: ${currentTopic}`;

            try {
                const response = await fetch('/api/generate_quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: lessonText })
                });
                
                questions = await response.json();

                if(questions.length === 0) {
                    document.getElementById('loading-ai').innerHTML = "<h2>Analysis Failed.</h2><p>The text was too short to generate a quiz.</p><button onclick='window.location.href=\"/lessons\"' class='option-btn' style='margin-top:20px;'>Back to Lessons</button>";
                    return;
                }

                document.getElementById('loading-ai').style.display = 'none';
                document.getElementById('quiz-area').style.display = 'block';
                showQuestion();

            } catch (err) {
                console.error(err);
                document.getElementById('loading-ai').innerText = "Error connecting to AI Server. Is app.py running?";
            }
        }

        function showQuestion() {
            if(currentIdx >= questions.length) {
                endQuiz(); 
                return;
            }

            const q = questions[currentIdx];
            document.getElementById('q-text').innerText = `Q${currentIdx+1}: ${q.text}`;
            const optsDiv = document.getElementById('options');
            optsDiv.innerHTML = "";
            document.getElementById('feedback').style.display = 'none';

            q.options.forEach((opt) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, q.correct_answer, q.explanation, btn);
                optsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selectedText, correctText, explain, btn) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            if(selectedText.trim() === correctText.trim()) {
                btn.classList.add('correct');
                document.getElementById('feedback-title').innerText = "Correct! âœ…";
                document.getElementById('feedback-title').style.color = "#2ecc71";
                score++;
            } else {
                btn.classList.add('wrong');
                buttons.forEach(b => {
                    if(b.innerText.trim() === correctText.trim()) b.classList.add('correct');
                });
                document.getElementById('feedback-title').innerText = "Incorrect âŒ";
                document.getElementById('feedback-title').style.color = "#e74c3c";
            }
            
            document.getElementById('feedback-msg').innerText = explain;
            document.getElementById('feedback').style.display = 'block';
        }

        window.nextQuestion = () => {
            currentIdx++;
            showQuestion();
        }

        initQuiz();
    </script>
</body>
</html>