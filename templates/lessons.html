<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LearnCore - Celestium</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; }
        .section-title { text-align: center; font-size: 2.5rem; margin: 40px 0 10px; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 40px; }
        .ai-badge { background: linear-gradient(45deg, #4facfe, #00f2fe); color: black; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        .discovery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto 80px; padding: 0 20px; }
        
        .topic-card { background: #161622; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: transform 0.3s; cursor: pointer; display: flex; flex-direction: column; }
        .topic-card:hover { transform: translateY(-5px); border-color: #4facfe; }
        
        .topic-img { width: 100%; height: 200px; object-fit: cover; background-color: #000; }
        .topic-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        
        .keywords { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .keyword { font-size: 0.75rem; color: #4facfe; border: 1px solid #4facfe; padding: 2px 6px; border-radius: 4px; }
        
        .action-area { margin-top: auto; display: flex; gap: 10px; }
        .read-btn, .quiz-btn { padding: 8px 15px; border-radius: 5px; cursor: pointer; border: 1px solid #555; background: transparent; color: #ddd; flex: 1; }
        .read-btn:hover { background: #333; border-color: #4facfe; }
        .quiz-btn { background: #4facfe; color: #000; border: none; font-weight: bold; }
        .quiz-btn:hover { background: #7ec2ff; }
        
        #lesson-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; overflow-y: auto; padding: 40px 0; }
        .modal-content { background: #1a1a2e; max-width: 900px; margin: 0 auto; border-radius: 10px; border: 1px solid #444; position: relative; padding: 0; overflow: hidden; }
        .modal-header-img { width: 100%; height: 350px; object-fit: cover; }
        .modal-body { padding: 30px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 3rem; color: white; cursor: pointer; z-index: 10; line-height: 0.5; text-shadow: 0 0 10px black; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        .stat-box { text-align: center; }
        .stat-label { color: #888; font-size: 0.8rem; }
        .stat-value { color: #4facfe; font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Celestium</div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/universe">Universe Explorer</a>
            <a href="/lessons">LearnCore</a>
            <a href="/quizzes">Quiz Zone</a>
        </div>
    </nav>

    <h1 class="section-title">AI-Generated Knowledge Feed</h1>
    <p class="subtitle">Live analysis from Python Backend</p>
    <p id="loading" style="text-align: center; color: #4facfe;">Connecting to Flask Server...</p>
    
    <div id="discovery-grid" class="discovery-grid"></div>

    <h2 class="section-title" style="border-top: 1px solid #333; padding-top: 40px;">Core Curriculum</h2>
    <div id="modules-container" class="discovery-grid"></div>

    <div id="lesson-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <img id="modal-img" class="modal-header-img" src="">
            <div class="modal-body">
                <h2 id="modal-title" style="margin-top: 0; color: #ffcc00; font-size: 2rem;"></h2>
                <div id="modal-stats" class="stats-grid" style="display: none;"></div>
                <div id="modal-text" style="line-height: 1.8; color: #ddd; font-size: 1.1rem;"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. STATIC MODULES (Core Curriculum) - Loaded First!
       // 2. STATIC MODULES (RICH DATA)
const coreLessons = [
    {
        title: "The Sun: Solar Engine",
        topic: "The Sun",
        image: "/static/textures/sun.jpg",
        content: "The Sun accounts for 99.86% of the solar system's mass. It is a G2V type star.",
        details: `
            <p>The Sun is a **G2V Yellow Dwarf** star at the heart of our Solar System. Its core temperature reaches **15 million °C**, driving **Nuclear Fusion**, which converts **Hydrogen** into **Helium** to produce all the energy that sustains life on Earth.</p>
            <h3 style="color:#ffcc00;">Structure and Composition</h3>
            <p>The Sun is massive, containing **99.86%** of the Solar System's total mass. Its primary composition is **73% Hydrogen** and **25% Helium**. The outer atmosphere, known as the **Corona**, extends millions of kilometers into space.</p>
        `,
        stats: [
            { label: "Type", value: "G2V Yellow Dwarf" },
            { label: "Surface Temp", value: "5,500°C" },
            { label: "Core Temp", value: "15 Million °C" },
            { label: "Composition", value: "73% Hydrogen" }
        ]
    },
    {
        title: "Mars: The Red Planet",
        topic: "Mars",
        image: "/static/textures/mars.jpg",
        content: "Mars is home to Olympus Mons and has a gravity of 3.72 m/s². It is the target for human exploration.",
        details: `
            <p>Mars is the fourth planet from the Sun and the second-smallest. It is red because its surface is covered in **Iron Oxide** (rust). The planet hosts **Olympus Mons**, the largest volcano in the Solar System, which stands **22 kilometers** high.</p>
            <h3 style="color:#ffcc00;">Environment and Exploration</h3>
            <p>The gravity on Mars is **3.72 m/s²** (about 38% of Earth's). Its thin atmosphere is **95% Carbon Dioxide**. NASA has sent five rovers, including **Perseverance**, to search for signs of ancient microbial life.</p>
        `,
        stats: [
            { label: "Gravity", value: "3.72 m/s²" },
            { label: "Day Length", value: "24h 37m" },
            { label: "Moons", value: "2 (Phobos, Deimos)" },
            { label: "Atmosphere", value: "95% CO2" }
        ]
    },
    {
        title: "Jupiter: King of Planets",
        topic: "Jupiter",
        image: "/static/textures/jupiter.jpg",
        content: "A gas giant more than twice as massive as all other planets combined. It has 95 official moons.",
        details: `
            <p>Jupiter is the largest planet, classified as a **Gas Giant**. It spins incredibly fast, completing a rotation in just **9 hours and 56 minutes**. It has **95** officially confirmed moons, including the four large Galilean satellites.</p>
            <h3 style="color:#4facfe;">The Great Red Spot</h3>
            <p>Jupiter is famous for the **Great Red Spot**, an immense storm that has raged for centuries. It is an **anticyclonic storm** that is wide enough to fit Earth inside its boundaries.</p>
        `,
        stats: [
            { label: "Type", value: "Gas Giant" },
            { label: "Moons", value: "95" },
            { label: "Rotation Period", value: "9h 56m" },
            { label: "Great Red Spot", value: "Anticyclonic Storm" }
        ]
    },

    {
        title: "Mercury: The Swift Messenger",
        topic: "Mercury",
        // Using an external image source as a fallback, replace with /static/textures/mercury.jpg if available
        image: "/static/textures/mercury.jpg", 
        content: "The smallest planet, Mercury has the shortest orbit and most extreme temperature swings in the Solar System.",
        details: `
            <p>Mercury is the first planet from the Sun and the smallest, slightly larger than Earth's Moon. It completes an orbit in just *88 Earth days*, making it the fastest planet. Its surface is rocky, heavily cratered, and resembles the Moon.</p>
            <h3 style="color:#ffcc00;">Extreme Temperatures</h3>
            <p>Due to its lack of a substantial atmosphere, Mercury has the most extreme temperature variations. Temperatures can soar to *430°C* during the day and plunge to *-180°C* at night. This massive *610°C* swing challenges probe design.</p>
        `,
        stats: [
            { label: "Orbit Period", value: "88 Earth Days" },
            { label: "Max Day Temp", value: "430°C" },
            { label: "Min Night Temp", value: "-180°C" },
            { label: "Moons", value: "0" }
        ]
    },

    {
        
        title: "Saturn: Lord of the Rings",
        topic: "Saturn",
        image: "/static/textures/saturn1.jpg",
        content: "Known for its magnificent ring system composed primarily of ice particles. It is a massive gas giant.",
        details: `
            <p>Saturn is the sixth planet from the Sun and the second-largest Gas Giant. Its most famous feature is its extensive, beautiful *ring system, made of billions of tiny pieces of **ice and rock* ranging in size from grains of sand to mountains.</p>
            <h3 style="color:#4facfe;">Low Density and Moons</h3>
            <p>Saturn is the only planet in the Solar System that is less dense than water; theoretically, it would float! It has *146* officially confirmed moons, including *Titan*, which is larger than the planet Mercury and has a thick atmosphere.</p>
        `,
        stats: [
            { label: "Rings", value: "7 Major Groups" },
            { label: "Density", value: "0.687 g/cm³ (Floats on Water)" },
            { label: "Moons", value: "146" },
            { label: "Largest Moon", value: "Titan" }
        ]
    }

    

];

        function loadModules() {
            const container = document.getElementById('modules-container');
            container.innerHTML = ""; 

            coreLessons.forEach(mod => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                
                const openData = () => openModal({
                    title: mod.title,
                    image: mod.image,
                    text: mod.details,
                    stats: mod.stats
                });

                card.onclick = (e) => { if(e.target.tagName !== 'BUTTON') openData(); };

                card.innerHTML = `
                    <img src="${mod.image}" class="topic-img" onerror="this.src='https://images-assets.nasa.gov/image/PIA00342/PIA00342~orig.jpg'">
                    <div class="topic-content">
                        <div class="ai-badge" style="background: linear-gradient(45deg, #ffcc00, #ffaa00);">CORE MODULE</div>
                        <h3 class="topic-title" style="color:white; margin:10px 0;">${mod.title}</h3>
                        <p style="color:#ccc; font-size:0.9rem;">${mod.content}</p>
                        <div class="action-area">
                            <button class="read-btn">Read</button>
                            <button class="quiz-btn">Start Quiz</button>
                        </div>
                    </div>
                `;
                
                card.querySelector('.read-btn').onclick = (e) => { e.stopPropagation(); openData(); };
                
                // QUIZ LOGIC FOR CORE MODULES
                card.querySelector('.quiz-btn').onclick = (e) => { 
                    e.stopPropagation();
                    const cleanText = mod.details.replace(/<[^>]*>?/gm, ''); 
                    localStorage.setItem('currentLessonText', cleanText);
                    localStorage.setItem('currentLessonTitle', mod.title);
                    window.location.href = '/quizzes'; 
                };

                container.appendChild(card);
            });
        }

        // 2. LIVE FEED (PYTHON API) - Loaded Async
        async function loadFeed() {
            try {
                const res = await fetch('/api/feed');
                
                // Crash Protection: Check if response is valid JSON array
                if (!res.ok) throw new Error("API Response Failed");
                
                const lessons = await res.json();
                
                if (!Array.isArray(lessons)) {
                    // Sometimes server returns {"error": "..."} instead of array
                    console.warn("Unexpected data format:", lessons);

                    if (lessons.error) {
                        throw new Error(lessons.error);
                    }

                    // If it's a single object, convert to array
                    lessons = [lessons];
                }3

                
                document.getElementById('loading').style.display = 'none';
                const container = document.getElementById('discovery-grid');

                lessons.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'topic-card';
                    
                    const tags = item.ai_keywords ? item.ai_keywords.map(k => `<span class="keyword">${k}</span>`).join('') : '';
                    
                    const openData = () => openModal({
                        title: item.title,
                        image: item.image,
                        text: `<b>AI Summary:</b> ${item.ai_summary}<br><br><hr style="border-color:#444"><br>${item.original_text}`,
                        stats: [ { label: "Date", value: item.date }, { label: "Read Time", value: item.read_time }, { label: "Source", value: "NASA" } ]
                    });

                    card.onclick = (e) => { if(e.target.tagName !== 'BUTTON') openData(); };

                    card.innerHTML = `
                        <img src="${item.image}" class="topic-img">
                        <div class="topic-content">
                            <div class="ai-badge">PROCESSED BY PYTHON</div>
                            <h3 class="topic-title" style="color:white; margin:10px 0;">${item.title}</h3>
                            <div class="keywords">${tags}</div>
                            <p style="color:#ccc; font-size:0.9rem;">${item.ai_summary}</p>
                            <div class="action-area">
                                <button class="read-btn">Read Analysis</button>
                                <button class="quiz-btn">Start Quiz</button>
                            </div>
                        </div>
                    `;
                    
                    card.querySelector('.read-btn').onclick = (e) => { e.stopPropagation(); openData(); };

                    // QUIZ LOGIC FOR LIVE FEED
                    card.querySelector('.quiz-btn').onclick = (e) => {
                        e.stopPropagation();
                        localStorage.setItem('currentLessonText', item.original_text);
                        localStorage.setItem('currentLessonTitle', item.title);
                        window.location.href = '/quizzes';
                    };
                    
                    container.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                const loadingElem = document.getElementById('loading');
                loadingElem.innerText = "Unable to fetch NASA Feed (API Limit or Network Error). Core Curriculum is active below.";
                loadingElem.style.color = "#ff4444";
            }
        }

        // 3. MODAL UTILITIES
        window.openModal = (data) => {
            document.getElementById('modal-title').innerText = data.title;
            document.getElementById('modal-img').src = data.image;
            document.getElementById('modal-text').innerHTML = data.text;
            
            const statsContainer = document.getElementById('modal-stats');
            if (data.stats) {
                statsContainer.style.display = 'grid';
                statsContainer.innerHTML = data.stats.map(s => `
                    <div class="stat-box">
                        <div class="stat-label">${s.label}</div>
                        <div class="stat-value">${s.value}</div>
                    </div>
                `).join('');
            } else {
                statsContainer.style.display = 'none';
            }
            document.getElementById('lesson-modal').style.display = 'block';
        }
        window.closeModal = () => document.getElementById('lesson-modal').style.display = 'none';
        window.onclick = (e) => { if(e.target == document.getElementById('lesson-modal')) closeModal(); }

        // LOAD ORDER: Modules first (Guaranteed), then Feed (Async)
        loadModules();
        loadFeed();
    </script>
</body>
</html>