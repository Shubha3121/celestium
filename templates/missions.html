<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mission Builder - Celestium</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; }
        .mission-container { max-width: 900px; margin: 50px auto; padding: 30px; background: #1a1a2e; border-radius: 12px; border: 1px solid #444; }
        .section-title { text-align: center; font-size: 2.5rem; margin-bottom: 10px; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }

        .mission-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }

        .command-input-area { background: #161622; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .command-input-area h3 { color: #4facfe; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        
        #command-list { 
            width: 100%; 
            min-height: 200px; 
            padding: 15px; 
            background: #0d0d1a; 
            color: #2ecc71; 
            font-family: monospace; 
            font-size: 1.1rem;
            border: 1px solid #4facfe; 
            border-radius: 4px; 
            resize: vertical;
            margin-bottom: 15px;
        }

        .controls button { padding: 10px 15px; margin-right: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #run-mission-btn { background: #2ecc71; color: #000; }
        #run-mission-btn:hover { background: #55f099; }
        #reset-btn { background: #f39c12; color: #000; }
        
        .legend-area {
    background: #161622;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #333;

    display: flex;
    flex-direction: column;
    align-items: center;

    min-height: 420px; /* üîë reserves space */
}

        .legend-area h3 { color: #ffcc00; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        .legend-item { margin-bottom: 10px; }
        .legend-code { font-weight: bold; color: #00f2fe; margin-right: 10px; font-family: monospace; }
        
        .simulation-output { margin-top: 30px; padding: 20px; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
        .status-success { background: #214332; color: #2ecc71; border: 1px solid #2ecc71; }
        .status-failed, .status-incomplete { background: #432121; color: #e74c3c; border: 1px solid #e74c3c; }
        .output-message { margin-top: 10px; font-weight: normal; font-size: 1rem; color: #ddd; }
        /* ================= FORCE MARS GRID VISIBILITY ================= */

.mars-grid {
    display: grid !important;

    grid-template-columns: repeat(4, 64px);
    grid-template-rows: repeat(4, 64px);
    gap: 12px;

    width: max-content;
    height: max-content;

    margin: 20px auto;

    background: rgba(0, 0, 0, 0.3);
    padding: 12px;
    border-radius: 10px;
}

/* Grid cells */
.mars-cell {
    width: 64px;
    height: 64px;

    background: #0d0d1a;
    border: 1px solid #444;
    border-radius: 8px;

    display: flex;
    align-items: center;
    justify-content: center;

    font-size: 1.7rem;
}
.keyboard-hint {
    margin-top: 12px;
    font-size: 0.9rem;
    color: #aaa;
    text-align: center;
}


    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Celestium</div>
        <div class="nav-links">
            <a href="/index.html">Home</a>
            <a href="/universe">Universe Explorer</a>
            <a href="/lessons">LearnCore</a>
            <a href="/quizzes">Quiz Zone</a>
            <a href="/missions">Mission Builder</a>
            <a href="/dashboard">Dashboard</a>
            <a href="#" id="loginBtn">Login</a>
        </div>
    </nav>

  <div class="mission-container">

    <h1 class="section-title">üöÄ Mission Builder</h1>
    <p class="subtitle">
        Program a Mars Rover mission using real command logic inspired by NASA operations.
    </p>

    <!-- MISSION BRIEFING -->
    <div class="mission-brief">
        <h3>üì° Mission Briefing: ARES-1</h3>
        <p>
            The rover has landed on Mars. Ancient water traces are detected at a nearby site.
            Your task is to safely navigate the rover, analyze the terrain, and reach the target.
        </p>
    </div>

    <div class="mission-grid">

        <!-- COMMAND PANEL -->
        <div class="command-input-area">
            <h3>üß† Rover Command Program</h3>

            <textarea id="command-list"
                placeholder="Example:
F
F
R
A
R
F"></textarea>
<div class="rover-controls">
    <button id="btn-forward">‚¨Ü Forward</button>
    <button id="btn-right">‚û° Right</button>
    <button id="btn-analyze">üîç Analyze</button>
</div>
<div class="keyboard-hint">
    üéÆ Controls:
    <strong>W</strong> = Forward,
    <strong>D</strong> = Right,
    <strong>A</strong> = Analyze,
    <strong>Backspace</strong> = Undo
</div>



            <div class="controls">
                <button id="run-mission-btn">‚ñ∂ Run Mission</button>
                <button id="reset-btn">‚ü≤ Reset</button>
            </div>
        </div>

        <!-- MARS MAP -->
       <!--- <div class="legend-area">
            <h3>üó∫ Mars Terrain Map (4 √ó 4)</h3>

            <div class="mars-grid" id="mars-grid"></div>

            <div class="legend-item"><span class="legend-code">üöó</span> Rover Start</div>
            <div class="legend-item"><span class="legend-code">ü™®</span> Rock Obstacle</div>
            <div class="legend-item"><span class="legend-code">üíß</span> Water Sample</div>
        </div>
        <div class="legend-area">-->
    <h3>üó∫ Mars Terrain Map (4 √ó 4)</h3>

    <div class="mars-grid" id="mars-grid"></div>

    <div class="legend-item">üöó Rover Start</div>
    <div class="legend-item">ü™® Rock Obstacle</div>
    <div class="legend-item">üíß Water Sample</div>
</div>


    </div>

    <div id="simulation-output" class="simulation-output" style="display:none;"></div>

</div>


<div id="path-log-container" style="margin-top: 30px; display: none;">
    <h3 style="color:#00f2fe; border-bottom: 1px solid #00f2fe; padding-bottom: 10px;">Rover Path Log</h3>
    <table id="path-log-table" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.95rem;">
        <thead>
            <tr style="background: #222; color: #fff;">
                <th style="padding: 10px;">#</th>
                <th style="padding: 10px;">Command</th>
                <th style="padding: 10px;">End Position (X, Y)</th>
                <th style="padding: 10px;">Status</th>
                <th style="padding: 10px;">Details</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    // FIX: Wait for the entire page (DOM) to load before attempting to find elements
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- BUTTON REGISTRATION MOVED HERE ---
        document.getElementById('run-mission-btn').addEventListener('click', runMission);
        document.getElementById('reset-btn').addEventListener('click', resetSimulation);

       function resetSimulation() {
    document.getElementById('command-list').value = '';

    roverX = 0;
    roverY = 0;
    renderGrid(roverX, roverY);

    document.getElementById('simulation-output').style.display = 'none';
    document.getElementById('path-log-container').style.display = 'none';
}


        async function runMission() {
            const commandListElem = document.getElementById('command-list');
            const outputElem = document.getElementById('simulation-output');
            const logContainer = document.getElementById('path-log-container');
            const logTableBody = document.querySelector('#path-log-table tbody');
            
            // Clean and process input
            const commands = commandListElem.value.toUpperCase().replace(/[,\s]+/g, ' ').trim().split(' ').filter(cmd => cmd.length > 0);

            if (commands.length === 0) {
                alert("Please enter a command sequence.");
                return;
            }

            // Reset UI for new run
            outputElem.innerHTML = 'Simulating...';
            outputElem.style.display = 'block';
            outputElem.className = 'simulation-output'; 
            logContainer.style.display = 'none';
            logTableBody.innerHTML = ''; 

            try {
                const response = await fetch('/api/simulate_mission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ commands: commands })
                });

                const result = await response.json();
                
                let statusClass = '';
                if (result.status === 'Success') {
                    statusClass = 'status-success';
                } else if (result.status === 'Failed') {
                    statusClass = 'status-failed';
                } else {
                    statusClass = 'status-incomplete';
                }

                outputElem.className =`simulation-output ${statusClass}`;
                outputElem.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">MISSION STATUS: ${result.status.toUpperCase()}</div>
                    <div class="output-message">${result.message}</div>
                `;
                
                // --- Step-by-Step Log Rendering ---
                if (result.path_log && result.path_log.length > 0) {
                    logContainer.style.display = 'block';
                    
                    // Add table rows
                    result.path_log.forEach((step, index) => {
                        let statusColor = '#2ecc71';
                        if (step.status === 'Crashed' || step.status === 'Off Map') {
                            statusColor = '#e74c3c';
                        } else if (step.status === 'Goal') {
                            statusColor = '#ffcc00';
                        }

                        const row = logTableBody.insertRow();
                        row.style.background = index % 2 === 0 ? '#1a1a2e' : '#161622';
                        
                        row.innerHTML = `
                            <td style="padding: 10px;">${index + 1}</td>
                            <td style="padding: 10px; font-weight: bold; color: ${statusColor};">${step.command}</td>
                            <td style="padding: 10px;">(${step.x}, ${step.y})</td>
                            <td style="padding: 10px; color: ${statusColor};">${step.status.toUpperCase()}</td>
                            <td style="padding: 10px;">${step.message}</td>
                        `;
                        
                        // Stop logging after a failure/success event is found
                        if (step.status === 'Crashed' || step.status === 'Off Map' || step.status === 'Goal') {
                            // This uses a throw/catch pattern to break the forEach loop elegantly
                            throw new Error("Log End"); 
                        }
                    });
                }


            } catch (error) {
                // Ignore the "Log End" break, handle other errors
                if (error.message !== "Log End") { 
                     console.error('Simulation Error:', error);
                     outputElem.className = 'simulation-output status-failed';
                     outputElem.innerHTML = '<div style="font-size: 1.5rem; margin-bottom: 5px;">SYSTEM ERROR</div><div class="output-message">Could not connect to the Python backend. Check server logs.</div>';
                }
            }
        }
    }); // End of DOMContentLoaded listener
</script>
<script>
    // --- BROWIE CHALLENGE: CHAOS MODE STATE MANAGER ---
    
    // 1. Initial Check: Load state from local storage on page load
    document.addEventListener('DOMContentLoaded', function() {
        const chaosEnabled = localStorage.getItem('chaosMode') === 'true';
        const chaosToggleBtn = document.getElementById('chaos-mode-toggle');

        if (chaosEnabled) {
            document.body.classList.add('chaos-mode-active');
            chaosToggleBtn.innerText = 'EXIT CHAOS MODE';
        } else {
            chaosToggleBtn.innerText = 'CHAOS MODE';
        }
        // Make the button visible for the demo
        chaosToggleBtn.style.display = 'block'; 

        // 2. Toggle Handler
        chaosToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const newState = !document.body.classList.contains('chaos-mode-active');
            
            if (newState) {
                document.body.classList.add('chaos-mode-active');
                localStorage.setItem('chaosMode', 'true');
                chaosToggleBtn.innerText = 'EXIT CHAOS MODE';
            } else {
                document.body.classList.remove('chaos-mode-active');
                localStorage.setItem('chaosMode', 'false');
                chaosToggleBtn.innerText = 'CHAOS MODE';
            }
        });
    });
</script>
<script>
/* ================= MARS GRID RENDER (FINAL) ================= */

document.addEventListener("DOMContentLoaded", () => {
    const marsGrid = document.getElementById("mars-grid");

    const terrain = [
        ["R", "", "X", ""],
        ["", "X", "", ""],
        ["", "", "", "G"],
        ["", "", "", ""]
    ];

    function renderGrid(roverX = 0, roverY = 0) {
        marsGrid.innerHTML = "";

        for (let y = 3; y >= 0; y--) {
            for (let x = 0; x < 4; x++) {
                const cell = document.createElement("div");
                cell.className = "mars-cell";

                if (x === roverX && y === roverY) {
                    cell.textContent = "üöó";
                    cell.style.background = "#214332";
                } else if (terrain[y][x] === "X") {
                    cell.textContent = "ü™®";
                    cell.style.background = "#432121";
                } else if (terrain[y][x] === "G") {
                    cell.textContent = "üíß";
                    cell.style.background = "#3a2f0b";
                }

                marsGrid.appendChild(cell);
            }
        }
    }

    renderGrid();
});
</script>

<script>
/* ================= KEYBOARD CONTROLS ================= */

document.addEventListener("keydown", (e) => {
    // Ignore typing inside textarea
    if (e.target.tagName === "TEXTAREA") return;

    const key = e.key.toLowerCase();

    if (key === "w") {
        handleCommand("F");
    } 
    else if (key === "d") {
        handleCommand("R");
    } 
    else if (key === "a") {
        handleCommand("A");
    } 
    else if (key === "backspace") {
        undoLastCommand();
        e.preventDefault();
    }
});

function handleCommand(cmd) {
    // Update rover position visually
    if (cmd === "F") roverY++;
    if (cmd === "R") roverX++;

    // Append command
    document.getElementById("command-list").value += cmd + "\n";

    // Update grid
    renderGrid(roverX, roverY);
}

function undoLastCommand() {
    const box = document.getElementById("command-list");
    const lines = box.value.trim().split("\n");

    if (lines.length === 0) return;

    const last = lines.pop();

    // Reverse rover move
    if (last === "F") roverY--;
    if (last === "R") roverX--;

    box.value = lines.join("\n") + (lines.length ? "\n" : "");
    renderGrid(roverX, roverY);
}
</script>



</body>
</html>